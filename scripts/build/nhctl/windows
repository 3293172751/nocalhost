#!/usr/bin/env bash
#
# Build a windows binary from linux
#

set -eu -o pipefail

export GOOS=windows
export GOARCH=amd64

source ./scripts/build/nhctl/.variables

# Override TARGET
TARGET="build/nhctl-$GOOS-$GOARCH.exe"

git clone https://github.com/nocalhost/syncthing.git
cd syncthing
go run build.go -targetName=syncthing -nocalhostVersion="${VERSION}" -nocalhostCommitId="${GITCOMMIT}"
mv bin/syncthing ./../internal/nhctl/syncthing/bin/syncthing_windows_amd64 || true
COPY bin/syncthing ./../internal/nhctl/syncthing/bin/syncthing_windows_amd64 || true
cd ..
rm -fr syncthing || true
rmdir /s/q syncthing || true

echo "Building $TARGET"
go build -o "${TARGET}" --ldflags "${LDFLAGS}" "${SOURCE}"
